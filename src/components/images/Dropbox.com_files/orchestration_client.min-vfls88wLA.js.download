define(["require","exports","metaserver/static/js/campaigns/orchestration/orchestration_api","metaserver/static/js/campaigns/orchestration/constants","metaserver/static/js/campaigns/orchestration/logger","metaserver/static/js/campaigns/emitter"],(function(t,e,i,s,a,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.OrchestrationClientSingleton=void 0;class n extends i.OrchestrationClientApi{constructor(t=!0,e){super(),this.isFirstCall=!0,this.queue=[],this.state={campaigns_shown:[]},this.campaignsShownStash=[],this.activePromise=void 0,this.inRollout=t,this.logger=e||new a.OrchestrationClientLogger}getOrchestrationState(){return this.state}clearToolkitCampaignsFromState(){void 0!==this.state.campaigns_shown&&(this.state.campaigns_shown=this.getPromptShownCampaigns())}stashPromptShownCampaigns(){void 0!==this.state.campaigns_shown&&this.campaignsShownStash.push(this.getPromptShownCampaigns()),this.state.campaigns_shown=[]}popStashedPromptShownCampaigns(){const t=this.campaignsShownStash.pop();void 0!==t&&(this.state.campaigns_shown=t)}getPromptShownCampaigns(){return void 0!==this.state.campaigns_shown?this.state.campaigns_shown.filter(t=>t.load_method===s.LOAD_METHOD_PROMPT):[]}registerShownCampaigns(t,e){var i;if(e===s.PRIORITIZED_CLIENT&&"wait"===(null===(i=this.activePromise)||void 0===i?void 0:i.queuedClient)){const t=this.activePromise;t.parentResolve(),this.closePromise(t),this.logger.logSuccessEvent(t,this.state)}const a=t.filter(t=>{var e;return void 0===(null===(e=this.state.campaigns_shown)||void 0===e?void 0:e.find(e=>t.campaign_id===e.campaign_id))});this.state.campaigns_shown=[...a,...this.state.campaigns_shown?this.state.campaigns_shown:[]]}enqueueFetch(t,e,i,a=!0,o){var n;if(!this.inRollout)return e();if(!this.isValidLoadMethod(t))return Promise.reject(new Error(`${s.INVALID_LOAD_METHOD_MSG}: ${t[".tag"]}`));if(t===s.PRIORITIZED_CLIENT){if("wait"===(null===(n=this.activePromise)||void 0===n?void 0:n.queuedClient)){const s=this.activePromise;s.parentResolve();const a=new Promise((s,a)=>{this.enqueueAtStart(t,e,s,a,o,i)});return this.closePromise(s),this.logger.logSuccessEvent(s,this.state),a}}else a&&this.isFirstCall&&void 0!==s.PRIORITIZED_CLIENT&&this.waitForPrioritizedClient();return this.isFirstCall=!1,new Promise((s,a)=>{this.enqueue(t,e,s,a,o,i),this.dequeue()})}buildPromiseMetadata(t,e,i,s,a,n=(()=>[])){const r={queuedClient:t,promiseBuilder:e,parentResolve:i,parentReject:s,conversionFunction:n,enqueueTime:Date.now(),action:null,actionValue:null};return(null==a?void 0:a.action)?(r.action=o.CAMPAIGN_EVENT,r.actionValue=a.action):(null==a?void 0:a.page)&&(r.action=o.PAGE_LOADED,r.actionValue=a.page),r}waitForPrioritizedClient(){return new Promise((t,e)=>{this.enqueue("wait",()=>new Promise((t,e)=>{setTimeout(t,s.CLIENT_TIMEOUT_MS)}),t,e),this.dequeue()})}enqueueAtStart(t,e,i,s,a,o=(()=>[])){const n=this.buildPromiseMetadata(t,e,i,s,a,o);this.queue.unshift(n)}enqueue(t,e,i,s,a,o=(()=>[])){const n=this.buildPromiseMetadata(t,e,i,s,a,o);this.queue.push(n)}dequeue(){if(void 0!==this.activePromise)return;const t=this.queue.shift();if(t){t.executionStartTime=Date.now(),this.activePromise=t;try{t.promiseBuilder(this.state).then(e=>{const i=t.conversionFunction(e);"string"!=typeof t.queuedClient&&this.registerShownCampaigns(i,t.queuedClient),t.parentResolve(e),this.closePromise(t),this.logger.logSuccessEvent(t,this.state)}).catch(e=>{t.parentReject(e),this.closePromise(t),this.logger.logErrorEvent(t,this.state,e)})}catch(e){t.parentReject(e),this.closePromise(t),this.logger.logErrorEvent(t,this.state,e)}}}closePromise(t){t.finishTime=Date.now(),this.activePromise=void 0,this.dequeue()}isValidLoadMethod(t){return s.VALID_LOAD_METHODS.includes(t)}}e.OrchestrationClientSingleton=n}));
//# sourceMappingURL=orchestration_client.min.js-vflEzdxF3.map