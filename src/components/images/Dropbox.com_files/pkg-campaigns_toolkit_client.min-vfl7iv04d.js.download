define("metaserver/static/js/campaigns/campaigns_toolkit_client",["require","exports","tslib","react","lodash","metaserver/static/js/modules/constants/page_load","metaserver/static/js/campaigns/emitter","metaserver/static/js/campaigns/api","metaserver/static/js/core/exception","metaserver/static/js/onboarding/logging/events","metaserver/static/js/campaigns/fullscreen_formats","metaserver/static/js/campaigns/utils/logging","metaserver/static/js/campaigns/types","metaserver/static/js/campaigns/history_utils","metaserver/static/js/campaigns/utils/pap_logging","metaserver/static/js/campaigns/orchestration/orchestration_factory","metaserver/static/js/campaigns/orchestration/constants","metaserver/static/js/campaigns/delay"],(function(e,a,t,n,i,s,o,r,c,m,p,l,g,u,_,d,v,E){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.CampaignsToolkit=a.fetchCampaigns=void 0,n=t.__importStar(n),s=t.__importStar(s),r=t.__importStar(r),c=t.__importStar(c);const f=e=>e.map(e=>{const a=e.campaign;return{campaign_id:a.campaign_id,version_id:a.version_id,slot:e.slotId[".tag"],load_method:v.LOAD_METHOD_TOOLKIT}});a.fetchCampaigns=(e={},a,n,i,o)=>t.__awaiter(void 0,void 0,void 0,(function*(){try{if(!e||!e.page)return[];const c=a=>t.__awaiter(void 0,void 0,void 0,(function*(){const t=[],{campaigns_result:o,campaigns_to_slots:c}=yield r.getBestCampaignsForUser({campaign_properties:e,event_context:{file_extension:(null==n?void 0:n.file_extension)&&n.file_extension,file_name:(null==n?void 0:n.file_name)&&n.file_name,upload_error_type:(null==n?void 0:n.upload_error_type)&&n.upload_error_type,file_path:(null==n?void 0:n.file_path)&&n.file_path,file_extensions_in_directory:(null==n?void 0:n.file_extensions_in_directory)&&n.file_extensions_in_directory,page_path:null==n?void 0:n.page_path,overwrote:null==n?void 0:n.overwrote},locale:s.PAGE_LOCALE,load_method:i,orchestration_state:a});return null==o||o.campaigns.forEach(e=>{var a,n;t.push({campaign:e,requestId:null==o?void 0:o.request_id,slotId:null!==(a=null==c?void 0:c[e.version_id])&&void 0!==a?a:{".tag":"other"},currentSequenceStep:null===(n=e.sequence)||void 0===n?void 0:n.root})}),t}));return yield a.enqueueFetch(v.LOAD_METHOD_TOOLKIT,c,f,o,e)}catch(a){c.reportException({err:a,tags:["fetchCampaigns","campaigns"],severity:c.SEVERITY.NONCRITICAL,exc_extra:{args:e}})}return[]}));const C=e=>{const a={};return e.forEach(e=>{e.currentSequenceStep&&(a[e.campaign.campaign_id]=e.currentSequenceStep)}),a},S=[g.CampaignEvents.DOWNLOAD_BUTTON_CLICKED,g.CampaignEvents.FILE_SHARE_SUCCESS,g.CampaignEvents.FILE_UPLOAD_FAILURE,g.CampaignEvents.SHARE_MODAL_CLOSED,g.CampaignEvents.PAGE_LOAD,g.CampaignEvents.FILE_UPLOAD_SUCCESS,g.CampaignEvents.DELETE_SUCCESS];a.CampaignsToolkit=({emitter:e=o.campaignsEmitter,loadMethod:s,shouldExpectPromptToLoad:r})=>{const[{campaigns:c,page:g,context:v,sequenceMap:f,selectiveCampaign:O,delayCampaignTimeouts:h},A]=(0,n.useState)({campaigns:[],page:"",context:void 0,sequenceMap:{},selectiveCampaign:void 0,delayCampaignTimeouts:[]}),j=d.OrchestrationFactory.getInstance();return(0,n.useEffect)(()=>{const a=({data:{page:e,context:a}})=>{var t;const n=new URL(window.location.href),i=null!==(t=n.searchParams.get("_spec_campaign"))&&void 0!==t?t:void 0;(0,E.clearTimeouts)(h),A(t=>Object.assign(Object.assign({},t),{page:e,context:a&&Object.assign(Object.assign({},a),{page_path:n.pathname}),selectiveCampaign:i})),(0,u.resetHistoryForEvent)(o.PAGE_LOADED),(0,_.setPageName)(e)};return e.on(o.PAGE_LOADED,a),()=>{e.off(o.PAGE_LOADED,a),(0,E.clearTimeouts)(h)}},[]),(0,n.useEffect)(()=>{const a=({loadEventType:e})=>{e===o.PreviewPageLoadEventType.Mount?j.stashPromptShownCampaigns():j.popStashedPromptShownCampaigns()};return e.on(o.PREVIEW_PAGE_LOADED,a),()=>{e.off(o.PREVIEW_PAGE_LOADED,a)}},[]),(0,n.useEffect)(()=>{const a=()=>{(0,u.resetHistoryForEvent)(o.PAGE_CHANGED),(0,E.clearTimeouts)(h),j.clearToolkitCampaignsFromState(),A(e=>(e.campaigns.forEach(e=>{(0,o.clearCampaignInSlot)(e)}),Object.assign(Object.assign({},e),{campaigns:[],page:""})))};return e.on(o.PAGE_CHANGED,a),()=>{e.off(o.PAGE_CHANGED,a)}},[]),(0,n.useEffect)(()=>{const a=e=>{const a=c.filter(a=>{var t;const n=null===(t=null==a?void 0:a.campaign)||void 0===t?void 0:t.campaign_id;return!!n&&String(n)!==e}),t=(0,i.cloneDeep)(f);delete t[parseInt(e,10)],A(e=>Object.assign(Object.assign({},e),{campaigns:a,sequenceMap:t}))};return e.on(o.CAMPAIGN_DISMISSED,a),()=>{e.off(o.CAMPAIGN_DISMISSED,a)}},[c]),(0,n.useEffect)(()=>{const a=({campaignId:e,ctaId:a})=>{var t,n,s;const r=parseInt(e,10),p=c.find(e=>e.campaign.campaign_id===r),g=null==p?void 0:p.currentSequenceStep,u=null!==(n=null===(t=null==p?void 0:p.campaign.sequence)||void 0===t?void 0:t.nodes)&&void 0!==n?n:{},_={campaign:{campaign_id:r,version_id:-1,prompt_queried_at_ms:-1,campaign_name:"campaignWithOnlyCampaignId"},requestId:"",slotId:{".tag":"other"}};if(!(p&&g&&a&&g in u))return void(0,l.logCampaignSequenceEvent)(m.CampaignsToolkitSequenceEvents.MISSING_OR_INVALID_PARAMETERS,null!=p?p:_,g,a);const d=null===(s=u[g].children)||void 0===s?void 0:s[a];if(!d)return(0,l.logCampaignSequenceEvent)(m.CampaignsToolkitSequenceEvents.SEQUENCE_COMPLETED,p,g,a),void(0,o.emitCampaignDismissed)(e);const v=Object.assign(Object.assign({},p),{currentSequenceStep:d}),E=c.map(e=>e.campaign.campaign_id===r?v:e),C=(0,i.cloneDeep)(f);C[r]=d,A(e=>Object.assign(Object.assign({},e),{campaigns:E,sequenceMap:C})),(0,l.logCampaignSequenceEvent)(m.CampaignsToolkitSequenceEvents.PROGRESS_SEQUENCE,p,d,a),(0,o.emitCampaignToSlot)(v)};return e.on(o.CAMPAIGN_SEQUENCE_ACTION,a),()=>{e.off(o.CAMPAIGN_SEQUENCE_ACTION,a)}},[c,f]),(0,n.useEffect)(()=>{const n=({name:e,data:{context:n,loggingParams:c}={}})=>t.__awaiter(void 0,void 0,void 0,(function*(){if(!S.includes(e))return;(0,E.clearTimeouts)(h);const t=yield(0,a.fetchCampaigns)({page:g,action:e,path:window.location.pathname},j,n,s,r),c=C(t);A(e=>Object.assign(Object.assign({},e),{campaigns:(0,i.uniqBy)([...e.campaigns,...t].reverse(),o.getSlotFromCampaignFormatProps),sequenceMap:Object.assign(Object.assign({},e.sequenceMap),c),delayCampaignTimeouts:(0,E.emitCampaignsWithDelay)(t,n)}))}));return e.on(o.CAMPAIGN_EVENT,n),()=>{e.off(o.CAMPAIGN_EVENT,n)}},[g]),(0,n.useEffect)(()=>{g&&t.__awaiter(void 0,void 0,void 0,(function*(){const e=yield(0,a.fetchCampaigns)({page:g,selective_campaign:O||void 0,path:window.location.pathname},j,v,s,r),t=C(e);A(a=>Object.assign(Object.assign({},(0,i.omit)(a,"context")),{campaigns:e,sequenceMap:t,selectiveCampaign:void 0,delayCampaignTimeouts:(0,E.emitCampaignsWithDelay)(e,v)}))}))},[g]),n.default.createElement(p.FullscreenFormats,null)}})),define("metaserver/static/js/campaigns/campaigns_toolkit_client_async",["require","exports","tslib","react","js/common/rendering","metaserver/static/js/campaigns/emitter"],(function(e,a,t,n,i,s){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.RootComponent=a.CampaignsToolkitClient=void 0;const o=(n=t.__importDefault(n)).default.lazy(()=>t.__awaiter(void 0,void 0,void 0,(function*(){const{CampaignsToolkit:a}=yield new Promise((a,t)=>{e(["metaserver/static/js/campaigns/campaigns_toolkit_client"],a,t)}).then(t.__importStar);return{default:a}})));a.CampaignsToolkitClient=e=>n.default.createElement(i.LazySuspense,{fallback:null},n.default.createElement(o,Object.assign({},e)));a.RootComponent=e=>n.default.createElement(a.CampaignsToolkitClient,{emitter:s.campaignsEmitter,loadMethod:"pagelet",shouldExpectPromptToLoad:e.shouldExpectPromptToLoad})})),define("metaserver/static/js/campaigns/campaign_enums",["require","exports"],(function(e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.CampaignPageName=void 0,(function(e){e.BROWSE="browse",e.TRANSFER="transfer",e.DASH_HOME="dash_home",e.BUY_PLUS="buy_plus",e.SIGNATURES="signatures"})(a.CampaignPageName||(a.CampaignPageName={}))})),define("metaserver/static/js/campaigns/fullscreen_formats",["require","exports","tslib","react","metaserver/static/js/campaigns/campaign_formats/index_new"],(function(e,a,t,n,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0}),a.FullscreenFormats=void 0,n=t.__importDefault(n);a.FullscreenFormats=()=>n.default.createElement(i.CampaignSlot,{slotId:"fullscreen_overlay"})}));
//# sourceMappingURL=pkg-campaigns_toolkit_client.min.js-vflQEMl3h.map