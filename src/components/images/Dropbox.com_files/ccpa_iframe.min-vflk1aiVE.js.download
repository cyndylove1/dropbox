define(["require","exports","tslib","react","typescript/dropbox/proto/js_init_data/privacy_consent/privacy_consent_pb","metaserver/static/js/ccpa_iframe/ccpa_preferences","metaserver/static/js/ccpa_iframe/gdpr_preferences","metaserver/static/js/ccpa_iframe/dns_cookie","js/proto_utils/unpack","metaserver/static/js/ccpa_iframe/dns_enrollment_state","metaserver/static/js/ccpa_iframe/api","metaserver/static/js/components/ui/css","metaserver/static/js/core/notify","metaserver/static/js/core/i18n","metaserver/static/js/ccpa_iframe/preferences_button","@dropbox/dig-icons","@dropbox/dig-icons/assets","metaserver/static/js/privacy_consent/i18n","metaserver/static/js/ccpa_iframe/consent_banner","metaserver/static/js/privacy_consent/privacy_consent_cookies","metaserver/static/js/ccpa_iframe/reentry_popout"],(function(e,t,n,o,a,i,s,r,l,c,m,d,g,E,C,_,S,p,u,N,f){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RootComponent=t.CCPAIFrame=void 0,o=n.__importStar(o),a=n.__importStar(a);const D=E.intl.formatMessage({id:"MURQNI",defaultMessage:"Success! Do not sell or share my personal information is now active."}),y=E.intl.formatMessage({id:"T6SVre",defaultMessage:"Success! Settings are saved."}),P=E.intl.formatMessage({id:"6w278K",defaultMessage:"Something went wrong! Try again later."}),A="settings",I="floating_button",v="floating_button_closed",k="banner",w="nothing";t.CCPAIFrame=e=>{const{consentIframeOrigin:t,dnsState:n,userEmails:l,verifiedEmails:d,unverifiedEmails:b,loggingContext:O,ccpaToken:M,isGpcEnabled:L,localizedTextOverrides:T,csrfToken:h}=e,G=n===a.UserDNSInitState.LOGGED_IN_ENROLLED||n===a.UserDNSInitState.LOGGED_IN_NOT_ENROLLED||n===a.UserDNSInitState.LOGGED_IN_EMAIL_PENDING,U=new URLSearchParams(window.location.search),R="true"===U.get("hide_gdpr"),F="true"===U.get("is_migration_gate_enabled"),B="true"===U.get("should_disable_banner"),j="true"===U.get("should_auto_open_options"),V=U.get("parent_domain_consent_cookie"),x=V?JSON.parse(decodeURIComponent(V)):void 0,H=new N.ConsentCookieStore({}),q=x?x.userInteracted:H.hasUserInteracted(),K=navigator.userAgent.toLowerCase(),Y=K.includes("iphone")||K.includes("ipod");(0,o.useEffect)(()=>{const e=(0,c.shouldEnrollLocally)(X)||(0,c.shouldUnenrollLocally)(X),n=new Date;if(n.setMonth(n.getMonth()+r.DEFAULT_DNS_DURATION_MONTHS),window.parent.postMessage({message_type:"CCPA_IFRAME_INIT",dns_enrolled:(0,c.isEnrollmentSelected)(X),localized_text_overrides:T,expireDate:e?n:null},t),(L||navigator.globalPrivacyControl)&&window.parent.postMessage({message_type:"DNS_GPC_SIGNAL"},t),null!=h&&""!==h)try{const e=JSON.parse(atob(h.split(".")[1])).origin;window.top.postMessage({message_type:"CSRF_HANDSHAKE_START",token:h},e)}catch(e){}F&&(je(Z,Ge)&&(Ve(),Oe(!1)),xe(),$e()),window.parent.postMessage({message_type:"IFRAME_FINISHED_LOADING"},t)},[]);const[Q,z]=(0,o.useState)(()=>""),[W,J]=(0,o.useState)(!1),[Z,$]=(0,o.useState)((e=>e===a.UserDNSInitState.LOGGED_IN_ENROLLED?c.DNSEnrollmentState.EnrolledAccount:e===a.UserDNSInitState.LOGGED_IN_EMAIL_PENDING?c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation:e===a.UserDNSInitState.LOGGED_OUT_ENROLLED?c.DNSEnrollmentState.EnrolledEmail:e===a.UserDNSInitState.LOGGED_OUT_EMAIL_PENDING?c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation:e===a.UserDNSInitState.LOGGED_OUT_GPC_ENABLED?c.DNSEnrollmentState.EnrollmentPendingEmailUIConfirmation:c.DNSEnrollmentState.NotEnrolled)(n)),[X,ee]=(0,o.useState)(Z),[te,ne]=(0,o.useState)(!1),[oe,ae]=(0,o.useState)({}),[ie,se]=(0,o.useState)(!1),[re,le]=(0,o.useState)(0),[ce,me]=(0,o.useState)(!1),[de]=(0,o.useState)(!0),[ge,Ee]=(0,o.useState)(!1),[Ce,_e]=(0,o.useState)(!1),[Se,pe]=(0,o.useState)(!1),[ue,Ne]=(0,o.useState)(!1),[fe,De]=(0,o.useState)(!1),[ye,Pe]=(0,o.useState)(!1),[Ae,Ie]=(0,o.useState)(E.intl.formatMessage(p.SAVE_BUTTON)),[ve]=(0,o.useState)(E.intl.formatMessage(p.CANCEL_BUTTON)),[ke,we]=(0,o.useState)(!0),[be,Oe]=(0,o.useState)(!q&&!j),[Me,Le]=(0,o.useState)(j||R),[Te,he]=(0,o.useState)(!1),[Ge]=(0,o.useState)(H.getAllowedCategoriesMap(x)),[Ue]=(0,o.useState)(H.getAllowedCategoriesMap(x)),Re=()=>{const e=(0,c.isEnrollmentSelected)(X),t=nt(),n=ie?h:void 0;e?(0,m.submitDNSSettings)(e,Je,Q,O,M,n,t):e||(0,m.submitDNSSettings)(e,Ze,Q,O,M,n,t)},Fe=e=>{if(e.origin===t)switch(e.data.message_type){case"DNS_SETTINGS_CONFIRMED":Re();break;case"DNS_SETTINGS_CANCELLED":Pe(!1),ee(Z);break;case"PRIVACY_CONSENT_PAGE_INFO":(e=>{const t={};e.hostname&&(t.hostname=e.hostname),e.foreign_session_id&&(t.foreign_session_id=e.foreign_session_id),e.client_info&&(t.client_info=e.client_info),ae(t)})(e.data);break;case"CSRF_HANDSHAKE_END":e.data.token===h&&se(!0);break;case"SHOW_SETTINGS":Le(!0);break;case"ENABLE_AND_SHOW_FLOATING_BUTTON":he(!0)}};(0,o.useLayoutEffect)(()=>{F||window.parent.postMessage({message_type:"CCPA_IFRAME_RESIZE",height:window.document.body.offsetHeight},t)}),(0,o.useEffect)(()=>{if(!Y){const e=()=>{var e;const n=null===(e=document.getElementById("ccpa_consent_banner"))||void 0===e?void 0:e.offsetHeight;n&&window.parent.postMessage({message_type:"CCPA_IFRAME_RESIZE",height:n+10},t)};return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}}},[t]),(0,o.useEffect)(()=>(window.addEventListener("message",Fe),()=>{window.removeEventListener("message",Fe)}),[X,Q,oe,ie]),(0,o.useEffect)(()=>{(te||L||navigator.globalPrivacyControl)&&((0,c.isEnrollmentPendingUIConfirmation)(X)?window.parent.postMessage({message_type:"DNS_PENDING_ENABLED",logged_in:G},t):(0,c.isUnenrollmentPendingUIConfirmation)(X)?window.parent.postMessage({message_type:"DNS_PENDING_DISABLED"},t):(X===Z||(0,c.isGPCUserResetState)(X,!(!L&&!navigator.globalPrivacyControl)))&&window.parent.postMessage({message_type:"DNS_PENDING_RESET",dns_enabled:(0,c.isEnrollmentSelected)(X)},t))},[X]),(0,o.useEffect)(()=>{(te||L||navigator.globalPrivacyControl)&&(W?(Pe(!1),window.parent.postMessage({message_type:"DNS_EMAIL_VALID"},t)):(Pe(!0),window.parent.postMessage({message_type:"DNS_EMAIL_INVALID"},t)))},[W]);const Be=()=>{X===c.DNSEnrollmentState.NotEnrolled||X===c.DNSEnrollmentState.UnenrollmentPendingEmailUIConfirmation||X===c.DNSEnrollmentState.UnenrollmentPendingAccountUIConfirmation?(Ge[N.CookieCategory.StrictlyNecessary]=!0,Ge[N.CookieCategory.MarketingAdvertising]=ge,Ge[N.CookieCategory.PerformanceFunctionality]=ue,Ge[N.CookieCategory.SocialMediaAdvertising]=Ce,Ge[N.CookieCategory.Analytics]=Se):Qe()},je=(e,t)=>Boolean((0,c.isEnrollmentSelected)(e)&&(0===Object.keys(Ge).length||!H.onlyStrictlyNecessaryConsent(Ge))),Ve=()=>{Qe(),Ye(),ze(!0)},xe=()=>{Ee(Ue.hasOwnProperty(N.CookieCategory.MarketingAdvertising)&&!0===Ue[N.CookieCategory.MarketingAdvertising]),Ne(Ue.hasOwnProperty(N.CookieCategory.PerformanceFunctionality)&&!0===Ue[N.CookieCategory.PerformanceFunctionality]),_e(Ue.hasOwnProperty(N.CookieCategory.SocialMediaAdvertising)&&!0===Ue[N.CookieCategory.SocialMediaAdvertising]),pe(Ue.hasOwnProperty(N.CookieCategory.Analytics)&&!0===Ue[N.CookieCategory.Analytics]);let e=0;Object.values(N.CookieCategory).forEach(t=>{t!==N.CookieCategory.StrictlyNecessary&&t!==N.CookieCategory.AllCookies&&Ue.hasOwnProperty(t)&&!0===Ue[t]&&++e}),me(e>0),le(e),ee(Z),De(Z!==c.DNSEnrollmentState.NotEnrolled),Pe(!1),Ie(E.intl.formatMessage(p.SAVE_BUTTON)),Object.values(N.CookieCategory).forEach(e=>{Ge[e]=Ue[e]})},He=(e,t,n)=>{if(ne(!0),t===s.GDPRCategories.allCategories)me(e),Ee(e),_e(e),pe(e),Ne(e),le(e?4:0);else{n=void 0===n?0:n,t===s.GDPRCategories.generalMarketing?Ee(e):t===s.GDPRCategories.socialMedia?_e(e):t===s.GDPRCategories.analytics?pe(e):t===s.GDPRCategories.performanceFunctionality&&Ne(e);const o=e?n+1:n-1;le(o),me(0!==o)}},qe=(0,o.useCallback)(e=>{const n={message_type:"DISPLAY_STATE_CHANGED",display_state:e};window.parent.postMessage(n,t)},[t]);(0,o.useEffect)(()=>{Me?(qe(A),we(!0),Oe(!1)):qe(!be||B||Me?!Te||be&&!B||Me?w:v:k)},[Me,be,Te,B,qe]);const Ke=()=>{Object.values(N.CookieCategory).forEach(e=>{e!==N.CookieCategory.AllCookies&&(Ge[e]=!0)})},Ye=()=>{Object.values(N.CookieCategory).forEach(e=>{Ue[e]=Ge[e]})},Qe=()=>{Object.values(N.CookieCategory).forEach(e=>{e!==N.CookieCategory.AllCookies&&(Ge[e]=e===N.CookieCategory.StrictlyNecessary)})},ze=e=>{window.parent.postMessage({message_type:"CONSENT_CHANGED_VIA_CCPA",categories:Ge,should_avoid_reload:e},t)},We=e=>{ne(!0),e?Z===c.DNSEnrollmentState.NotEnrolled?G?ee(c.DNSEnrollmentState.EnrollmentPendingAccountUIConfirmation):(ee(c.DNSEnrollmentState.EnrollmentPendingEmailUIConfirmation),Pe(!W),Ie(E.intl.formatMessage(p.SEND_VERIFICATION))):Z===c.DNSEnrollmentState.EnrolledEmail||Z===c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation?ee(Z):Z!==c.DNSEnrollmentState.EnrolledAccount&&Z!==c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation||ee(Z):(Z===c.DNSEnrollmentState.EnrolledEmail||Z===c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation?ee(c.DNSEnrollmentState.UnenrollmentPendingEmailUIConfirmation):Z===c.DNSEnrollmentState.EnrolledAccount||Z===c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation?ee(c.DNSEnrollmentState.UnenrollmentPendingAccountUIConfirmation):Z===c.DNSEnrollmentState.NotEnrolled&&ee(c.DNSEnrollmentState.NotEnrolled),Ie(E.intl.formatMessage(p.SAVE_BUTTON)),Pe(!1)),De(F&&e)},Je=e=>{e?g.Notify.success(D):g.Notify.error(P),G?(ee(c.DNSEnrollmentState.EnrollmentPendingAccountVerificationSent),$(c.DNSEnrollmentState.EnrollmentPendingAccountConfirmation)):(ee(c.DNSEnrollmentState.EnrollmentPendingEmailVerificationSent),$(c.DNSEnrollmentState.EnrollmentPendingEmailConfirmation));const n=new Date;n.setMonth(n.getMonth()+r.DEFAULT_DNS_DURATION_MONTHS),window.parent.postMessage({message_type:"DNS_ENABLED",logged_in:G,isOptInToDNS:!0,expireDate:n},t),R||ze()},Ze=e=>{e?g.Notify.success(y):g.Notify.error(P),ee(c.DNSEnrollmentState.NotEnrolled),$(c.DNSEnrollmentState.NotEnrolled),window.parent.postMessage({message_type:"DNS_DISABLED"},t),R||ze()},$e=()=>{window.parent.postMessage({message_type:"CONSENT_CALLBACK",categories:Ge,callback_type:"PRIOR_CONSENT"},t)},Xe=e=>{z(e);null!==e.match(/^.+@.+\..+$/)?J(!0):J(!1)},et=e=>{e.preventDefault(),window.parent.postMessage({message_type:"CCPA_PRIVACY_PAGE_CLICK"},t)},tt=e=>{e.preventDefault(),window.parent.postMessage({message_type:"CCPA_COOKIE_FAQ_CLICK"},t)},nt=()=>({opt_in_source:L||navigator.globalPrivacyControl?m.CCPA_ACTION_SOURCE.GPC_UI:m.CCPA_ACTION_SOURCE.USER_INPUT,opt_in_domain:oe.hostname,opt_in_client:oe.client_info,foreign_session_id:oe.foreign_session_id}),ot=E.intl.formatMessage({id:"bYgnak",defaultMessage:"Dropbox uses different categories of cookies to provide, protect, improve, and promote our website and services. Information on these categories and their purposes are described below. For more information please see our <privacy>Privacy Policy</privacy> and <faq>Cookie FAQ page</faq>."},{privacy:e=>o.default.createElement("button",{id:"privacy-page-link",onClick:et,"data-uxa-log":"privacy_consent_detailed_view_privacy_page_link"},e),faq:e=>o.default.createElement("button",{id:"cookie-faq-link",onClick:tt,"data-uxa-log":"privacy_consent_detailed_view_cookie_faq_link"},e)});return o.default.createElement(o.default.Fragment,null,F&&o.default.createElement(o.default.Fragment,null,Me&&o.default.createElement("div",{className:"migration-ccpa"},o.default.createElement("div",{className:"scrollable-contents"},!R&&o.default.createElement(o.default.Fragment,null,o.default.createElement(_.UIIcon,{src:S.DropboxLine,size:"large",display:"inline-block"}),o.default.createElement("div",{className:"title-divider"}),o.default.createElement("label",{id:"consent-title-label",className:"consent-title-label"},E.intl.formatMessage(p.CONSENT_TITLE)),o.default.createElement("p",{id:"consent-title-blurb",className:"consent-title-blurb"},ot)),o.default.createElement(i.CCPAPreferences,{displayVariant:R?i.CCPAPreferencesVariant.CCPA_ONLY:i.CCPAPreferencesVariant.GDPR_EMBEDDED,checked:(0,c.isEnrollmentSelected)(X),disabled:!(!L&&!navigator.globalPrivacyControl),isFlowComplete:(0,c.isFlowComplete)(Z,X),onChange:We,onCookieFAQLinkClick:tt,gpcEnabled:!(!L&&!navigator.globalPrivacyControl),enrollmentState:X,email:Q,handleEmailChange:Xe,userEmails:l,verifiedEmails:d,unverifiedEmails:b}),!R&&o.default.createElement(s.GDPRPreferences,{checked:(0,c.isEnrollmentSelected)(X),disabled:fe,onChange:He,onCookieFAQLinkClick:tt,gdprCount:re,setGdprCount:le,allGdprToggle:ce,strictlyToggle:de,generalToggle:ge,socialToggle:Ce,analyticsToggle:Se,performanceToggle:ue})),o.default.createElement(C.PreferencesButton,{disabled:ye,onChange:e=>{e?(Be(),Ye(),Z!==X?Re():ze()):xe(),Le(R)},acceptButtonText:Ae,declineButtonText:ve})),!Me&&be&&!B&&o.default.createElement(u.ConsentBanner,{onClick:e=>{e===u.BannerComponentIDs.acceptAllCookiesButton?(Ke(),Ye(),He(!0,s.GDPRCategories.allCategories,0)):e===u.BannerComponentIDs.declineCookiesButton&&Qe(),ze(!0),Oe(!1)},onSettingsClick:e=>{e.preventDefault(),Le(!0),Oe(!1)},onPrivacyPageLinkClick:et,onPrivacyPolicyFaqLinkClick:e=>{e.preventDefault(),window.parent.postMessage({message_type:"CCPA_PRIVACY_POLICY_FAQ_CLICK"},t)}}),!Me&&!be&&Te&&o.default.createElement(f.CcpaReentryPopout,{onClick:e=>{e===f.PopoutButtonIDs.reentryButton?Le(!0):e===f.PopoutButtonIDs.collapseToggle&&(we(!ke),qe(ke?I:v))},isCollapsed:ke})),!F&&o.default.createElement(i.CCPAPreferences,{displayVariant:R?i.CCPAPreferencesVariant.CCPA_ONLY:i.CCPAPreferencesVariant.GDPR_EMBEDDED,checked:(0,c.isEnrollmentSelected)(X),disabled:!(!L&&!navigator.globalPrivacyControl),isFlowComplete:(0,c.isFlowComplete)(Z,X),onChange:We,onCookieFAQLinkClick:tt,gpcEnabled:!(!L&&!navigator.globalPrivacyControl),enrollmentState:X,email:Q,handleEmailChange:Xe,userEmails:l,verifiedEmails:d,unverifiedEmails:b}))},t.CCPAIFrame.displayName="CCPAIFrame";t.RootComponent=e=>{const n=(0,l.unmarshalProto)(e.encodedProto,a.CCPAIFrameInitData);n.consentIframeOrigin=`https://${n.consentIframeOrigin}`;const i=(0,d.requireCssWithComponent)(t.CCPAIFrame,["/static/metaserver/static/css/dig-components/index.web-vfllRi-uH.css","/static/metaserver/static/css/dig-components/tokens-vflajH0fT.css"]);return o.default.createElement(i,Object.assign({},n))}}));
//# sourceMappingURL=ccpa_iframe.min.js-vflbRbS3b.map